import { useState, useRef } from 'react'

function MalwareChecker({ onBack }) {
  const fileInputRef = useRef(null)
  const [file, setFile] = useState(null)
  const [result, setResult] = useState(null)
  const [analyzing, setAnalyzing] = useState(false)

  const dangerousExtensions = [
    'exe', 'bat', 'cmd', 'com', 'scr', 'vbs', 'js', 'jse', 'wsf', 'wsh',
    'ps1', 'pst', 'psy', 'msi', 'app', 'deb', 'rpm', 'dmg', 'pkg',
    'elf', 'bin', 'apk', 'jar', 'zip', 'rar', '7z', 'iso'
  ]

  const suspiciousExtensions = [
    'dll', 'sys', 'drv', 'ocx', 'so', 'dylib', 'tmp', 'log'
  ]

  const safeExtensions = [
    'txt', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx',
    'jpg', 'jpeg', 'png', 'gif', 'bmp', 'mp3', 'mp4', 'avi', 'mov',
    'csv', 'json', 'xml', 'html', 'css', 'md'
  ]

  // Magic numbers (file signatures) for validation
  const fileMagicNumbers = {
    'pdf': [0x25, 0x50, 0x44, 0x46], // %PDF
    'zip': [0x50, 0x4b, 0x03, 0x04], // PK
    'exe': [0x4d, 0x5a], // MZ
    'png': [0x89, 0x50, 0x4e, 0x47], // PNG
    'jpg': [0xff, 0xd8, 0xff], // JPEG
    'gif': [0x47, 0x49, 0x46], // GIF
    'doc': [0xd0, 0xcf, 0x11, 0xe0], // OLE2
  }

  const handleFileSelect = (e) => {
    const selectedFile = e.target.files?.[0]
    if (selectedFile) {
      setFile(selectedFile)
      setResult(null)
    }
  }

  const analyzeFile = async () => {
    if (!file) {
      alert('Please select a file')
      return
    }

    setAnalyzing(true)

    // Simulate analysis delay
    await new Promise(resolve => setTimeout(resolve, 1500))

    const fileName = file.name
    const fileSize = file.size
    const fileType = file.type
    const extension = fileName.split('.').pop().toLowerCase()

    let score = 0
    const warnings = []
    const safe = []
    let threatLevel = 'Safe'

    // 1. Extension check
    if (dangerousExtensions.includes(extension)) {
      warnings.push(`‚ùå CRITICAL: .${extension} is a highly dangerous executable format`)
      score += 50
    } else if (suspiciousExtensions.includes(extension)) {
      warnings.push(`‚ö† WARNING: .${extension} is a system-level file format`)
      score += 25
    } else if (safeExtensions.includes(extension)) {
      safe.push(`‚úì .${extension} is a safe file format`)
    } else {
      warnings.push(`‚ö† Unknown file extension: .${extension}`)
      score += 10
    }

    // 2. File size check
    const maxSafeSize = 100 * 1024 * 1024 // 100MB
    const suspiciousSize = 500 * 1024 * 1024 // 500MB

    if (fileSize === 0) {
      warnings.push('‚ö† Empty file detected - suspicious')
      score += 15
    } else if (fileSize > suspiciousSize) {
      warnings.push(`‚ö† File is unusually large (${(fileSize / 1024 / 1024).toFixed(2)}MB)`)
      score += 10
    } else if (fileSize > maxSafeSize) {
      safe.push(`‚úì File size is manageable (${(fileSize / 1024 / 1024).toFixed(2)}MB)`)
    } else {
      safe.push(`‚úì File size is reasonable (${(fileSize / 1024).toFixed(2)}KB)`)
    }

    // 3. MIME type validation
    const validMimeTypes = [
      'text/plain', 'application/pdf', 'text/csv',
      'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'image/jpeg', 'image/png', 'image/gif', 'image/bmp',
      'video/mp4', 'video/quicktime', 'audio/mpeg',
      'application/json', 'application/xml', 'text/html'
    ]

    if (fileType === '') {
      warnings.push('‚ö† MIME type not detected - file type unknown')
      score += 15
    } else if (fileType.includes('application/x-msdownload') || fileType.includes('application/x-msdos-program')) {
      warnings.push('‚ùå CRITICAL: File is identified as an executable')
      score += 60
    } else if (validMimeTypes.includes(fileType)) {
      safe.push(`‚úì MIME type verified: ${fileType}`)
    } else if (fileType.includes('application')) {
      warnings.push(`‚ö† Unknown application file type: ${fileType}`)
      score += 20
    }

    // 4. Filename pattern analysis
    if (fileName.includes('..')) {
      warnings.push('‚ö† Filename contains path traversal characters (..) - suspicious')
      score += 30
    }

    if (fileName.split('.').length > 3) {
      warnings.push('‚ö† Multiple file extensions detected - possible double extension attack')
      score += 25
    }

    if (fileName.match(/[^\w\s\.\-]/)) {
      warnings.push('‚ö† Filename contains unusual characters - possible obfuscation')
      score += 15
    }

    // 5. Common malware indicators in filename
    const malwarePatterns = [
      'virus', 'worm', 'trojan', 'ransom', 'spy', 'malware',
      'crack', 'keygen', 'hack', 'password', 'serial'
    ]

    if (malwarePatterns.some(pattern => fileName.toLowerCase().includes(pattern))) {
      warnings.push('‚ö† Filename contains suspicious keywords - possible malware')
      score += 40
    }

    // 6. Entropy-like analysis (file randomness heuristic)
    // Check for low entropy (compressed/encrypted) + executable
    if ((extension === 'exe' || extension === 'dll') && fileSize > 1000000) {
      warnings.push('‚ö† Large executable file - potential packer/obfuscator detected')
      score += 20
    }

    // Calculate final threat level
    score = Math.min(score, 100)

    if (score <= 10) threatLevel = 'Safe'
    else if (score <= 30) threatLevel = 'Low Risk'
    else if (score <= 60) threatLevel = 'Medium Risk'
    else if (score <= 80) threatLevel = 'High Risk'
    else threatLevel = 'Critical'

    // Generate scan signature
    const scanSignature = `${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 9)}`.toUpperCase()

    setResult({
      fileName,
      fileSize,
      fileType,
      extension,
      threatLevel,
      score,
      warnings,
      safe,
      scanSignature,
      scanTime: new Date().toLocaleString()
    })

    setAnalyzing(false)
  }

  const handleDragOver = (e) => {
    e.preventDefault()
    e.currentTarget.classList.add('border-terminal-green')
  }

  const handleDragLeave = (e) => {
    e.currentTarget.classList.remove('border-terminal-green')
  }

  const handleDrop = (e) => {
    e.preventDefault()
    e.currentTarget.classList.remove('border-terminal-green')
    const droppedFile = e.dataTransfer.files?.[0]
    if (droppedFile) {
      setFile(droppedFile)
      setResult(null)
    }
  }

  return (
    <div className="w-full min-h-screen bg-terminal-black overflow-x-hidden">
      {/* Header */}
      <div className="border-b border-terminal-green/20 px-4 sm:px-6 py-3 sm:py-4">
        <div className="w-full max-w-6xl mx-auto flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-0">
          <h1 className="text-xl sm:text-2xl font-bold">üî¨ Malware Checker</h1>
          <button
            onClick={onBack}
            className="text-terminal-cyan hover:text-terminal-green transition text-xs sm:text-sm w-fit"
          >
            ‚Üê Back
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
        <div className="border border-terminal-green/20 rounded p-4 sm:p-8 mb-6 sm:mb-8">
          <h2 className="text-lg sm:text-xl font-bold mb-4 sm:mb-6">Scan File for Malware</h2>
          <p className="text-terminal-cyan text-xs sm:text-sm mb-6 sm:mb-8">
            Upload any file to check for potential threats, malware signatures, and suspicious properties. 
            Our advanced heuristics analyze file structure, permissions, and known threat patterns.
          </p>

          {/* File Upload Area */}
          <div
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            className="border-2 border-dashed border-terminal-green/30 rounded-lg p-6 sm:p-8 text-center cursor-pointer hover:border-terminal-green/50 transition mb-6"
          >
            <p className="text-terminal-cyan mb-2 text-sm sm:text-base">üìÅ Drop file here or click to upload</p>
            <p className="text-xs text-terminal-green/60">Maximum file size: 500MB</p>
            <input
              ref={fileInputRef}
              type="file"
              onChange={handleFileSelect}
              className="hidden"
            />
            <button
              onClick={() => fileInputRef.current?.click()}
              className="mt-4 px-4 sm:px-6 py-2 border border-terminal-green text-terminal-green hover:bg-terminal-green hover:text-terminal-black transition-colors rounded text-xs sm:text-sm"
            >
              Browse Files
            </button>
          </div>

          {/* Selected File Display */}
          {file && (
            <div className="bg-terminal-dark border border-terminal-green/20 rounded p-3 sm:p-4 mb-6">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0">
                <div>
                  <p className="font-bold text-terminal-green mb-1 text-sm sm:text-base">üìÑ {file.name}</p>
                  <p className="text-xs text-terminal-cyan">
                    Size: {(file.size / 1024).toFixed(2)}KB | Type: {file.type || 'Unknown'}
                  </p>
                </div>
                <button
                  onClick={() => setFile(null)}
                  className="text-terminal-cyan hover:text-terminal-red transition text-xs sm:text-sm w-fit"
                >
                  ‚úï Clear
                </button>
              </div>
            </div>
          )}

          {/* Analyze Button */}
          <button
            onClick={analyzeFile}
            disabled={!file || analyzing}
            className="w-full border border-terminal-green text-terminal-green hover:bg-terminal-green hover:text-terminal-black disabled:opacity-50 disabled:cursor-not-allowed py-2 sm:py-3 px-4 sm:px-6 rounded transition-colors font-bold text-xs sm:text-base"
          >
            {analyzing ? 'üîç Analyzing...' : 'üîç Analyze File'}
          </button>
        </div>

        {/* Results */}
        {result && (
          <div className="space-y-4 sm:space-y-6">
            {/* Threat Level */}
            <div className={`border rounded p-4 sm:p-6 ${
              result.threatLevel === 'Safe' ? 'border-terminal-green bg-terminal-dark' :
              result.threatLevel === 'Low Risk' ? 'border-terminal-cyan bg-terminal-dark' :
              result.threatLevel === 'Medium Risk' ? 'border-terminal-yellow bg-terminal-dark' :
              result.threatLevel === 'High Risk' ? 'border-terminal-red/50 bg-terminal-dark' :
              'border-terminal-red bg-terminal-dark'
            }`}>
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0 mb-3 sm:mb-4">
                <h3 className="text-xl sm:text-2xl font-bold">
                  {result.threatLevel === 'Safe' ? '‚úì' : '‚ö†'} {result.threatLevel}
                </h3>
                <span className={`text-xs sm:text-sm font-bold px-2 sm:px-3 py-1 rounded w-fit ${
                  result.threatLevel === 'Safe' ? 'bg-terminal-green text-terminal-black' :
                  result.threatLevel === 'Low Risk' ? 'bg-terminal-cyan text-terminal-black' :
                  result.threatLevel === 'Medium Risk' ? 'bg-terminal-yellow text-terminal-black' :
                  result.threatLevel === 'High Risk' ? 'bg-terminal-red/50 text-terminal-green' :
                  'bg-terminal-red text-white'
                }`}>
                  {result.score}%
                </span>
              </div>

              {/* Risk Bar */}
              <div className="mb-4 sm:mb-6">
                <div className="w-full bg-terminal-darker border border-terminal-green/20 rounded h-3 overflow-hidden">
                  <div
                    className={`h-full transition-all ${
                      result.score <= 10
                        ? 'bg-terminal-green'
                        : result.score <= 30
                        ? 'bg-terminal-cyan'
                        : result.score <= 60
                        ? 'bg-terminal-yellow'
                        : result.score <= 80
                        ? 'bg-terminal-red/50'
                        : 'bg-terminal-red'
                    }`}
                    style={{ width: `${result.score}%` }}
                  />
                </div>
              </div>

              {/* File Details */}
              <div className="grid grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6 text-xs sm:text-sm">
                <div>
                  <p className="text-terminal-cyan/60 text-xs">Filename</p>
                  <p className="text-terminal-green font-mono truncate">{result.fileName}</p>
                </div>
                <div>
                  <p className="text-terminal-cyan/60 text-xs">File Size</p>
                  <p className="text-terminal-green">{(result.fileSize / 1024).toFixed(2)}KB</p>
                </div>
                <div>
                  <p className="text-terminal-cyan/60 text-xs">File Type</p>
                  <p className="text-terminal-green truncate">{result.fileType || 'Unknown'}</p>
                </div>
                <div>
                  <p className="text-terminal-cyan/60 text-xs">Extension</p>
                  <p className="text-terminal-green">.{result.extension}</p>
                </div>
              </div>

              {/* Scan Info */}
              <div className="border-t border-terminal-green/20 pt-3 sm:pt-4 text-xs text-terminal-green/60">
                <p>Scan ID: {result.scanSignature}</p>
                <p>Scan Time: {result.scanTime}</p>
              </div>
            </div>

            {/* Warnings */}
            {result.warnings.length > 0 && (
              <div className="border border-terminal-red/30 rounded p-4 sm:p-6 bg-terminal-dark">
                <p className="text-xs sm:text-sm text-terminal-red mb-2 sm:mb-3 font-bold">üö® Detected Issues ({result.warnings.length}):</p>
                <ul className="space-y-1 sm:space-y-2">
                  {result.warnings.map((warning, idx) => (
                    <li key={idx} className="text-xs sm:text-sm text-terminal-cyan">
                      {warning}
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {/* Safe Indicators */}
            {result.safe.length > 0 && (
              <div className="border border-terminal-green/30 rounded p-4 sm:p-6 bg-terminal-dark">
                <p className="text-xs sm:text-sm text-terminal-green mb-2 sm:mb-3 font-bold">‚úì Safe Indicators ({result.safe.length}):</p>
                <ul className="space-y-1 sm:space-y-2">
                  {result.safe.map((item, idx) => (
                    <li key={idx} className="text-xs sm:text-sm text-terminal-green">
                      {item}
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {/* Recommendations */}
            <div className="border border-terminal-green/20 rounded p-4 sm:p-6 bg-terminal-dark">
              <h3 className="font-bold mb-3 sm:mb-4 text-terminal-cyan text-sm sm:text-base">Recommendations:</h3>
              <ul className="space-y-1 sm:space-y-2 text-xs sm:text-sm">
                {result.threatLevel === 'Safe' ? (
                  <>
                    <li className="text-terminal-green">‚úì File appears to be safe</li>
                    <li className="text-terminal-green">‚Ä¢ You can safely open this file</li>
                    <li className="text-terminal-green">‚Ä¢ Still exercise caution with files from unknown sources</li>
                  </>
                ) : result.threatLevel === 'Low Risk' ? (
                  <>
                    <li className="text-terminal-cyan">‚ö† Minor concerns detected</li>
                    <li className="text-terminal-green">‚Ä¢ Use antivirus software before opening</li>
                    <li className="text-terminal-green">‚Ä¢ Verify the source is trustworthy</li>
                  </>
                ) : result.threatLevel === 'Medium Risk' ? (
                  <>
                    <li className="text-terminal-yellow">‚ö† Multiple risk factors detected</li>
                    <li className="text-terminal-red">‚Ä¢ Do NOT open unless absolutely necessary</li>
                    <li className="text-terminal-green">‚Ä¢ Scan with antivirus software first</li>
                    <li className="text-terminal-green">‚Ä¢ Verify with the file sender immediately</li>
                  </>
                ) : result.threatLevel === 'High Risk' ? (
                  <>
                    <li className="text-terminal-red">‚ùå Significant threat indicators</li>
                    <li className="text-terminal-red">‚Ä¢ DO NOT OPEN - File is likely malicious</li>
                    <li className="text-terminal-red">‚Ä¢ Delete immediately or move to quarantine</li>
                    <li className="text-terminal-green">‚Ä¢ Report to antivirus provider</li>
                  </>
                ) : (
                  <>
                    <li className="text-terminal-red">‚ùå CRITICAL THREAT DETECTED</li>
                    <li className="text-terminal-red">‚Ä¢ File is HIGHLY SUSPICIOUS - likely malware</li>
                    <li className="text-terminal-red">‚Ä¢ DELETE IMMEDIATELY - do not execute</li>
                    <li className="text-terminal-red">‚Ä¢ Report to your security team</li>
                  </>
                )}
              </ul>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

export default MalwareChecker
